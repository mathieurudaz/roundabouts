<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <style type="text/css">
        html, body{
            padding: 0px;
            margin:0px;
        }
        .btn{
            background-color: #f5f6f7;
            padding: 10px;
            display: inline-block;
        }
        .btn-group{
            position: absolute;
            z-index: 1;
        }
        canvas{
            position: fixed;
        }
    </style>
  </head>
  <body>
    <div class="btn-group">
        <div class="btn btn-graph-1">Graph A</div>
        <div class="btn btn-graph-2">Graph B</div>
        <div class="btn btn-graph-3">Map</div>
        <div class="btn btn-zoom">Zoom</div>
    </div>

    <div id="vis"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
    <script src="https://d3js.org/d3-force.v1.min.js"></script>
    <script type="text/javascript">

        var base = d3.select("#vis");
        var geodata
        var simulation

        var width = $(window).width(),
            height = $(window).height();

        var chart = base.append("canvas")
          .attr("width", width)
          .attr("height", height);

        var context = chart.node().getContext("2d");

        // set projection
        var projection = d3.geoMercator();

        // create path variable
        var path = d3.geoPath()
            .projection(projection);

        var zoom = d3.zoom()

        // Create an in memory only element of type 'custom'
        var detachedContainer = document.createElement("custom");

        // Create a d3 selection for the detached container. We won't
        // actually be attaching it to the DOM.
        var dataContainer = d3.select(detachedContainer);

        var dataBindingPoints

        d3.json("ch_roundabouts-EPSG4326.geojson", function(error, geo){
            geodata = geo

            // set projection parameters
            projection
              .scale(13000)
              .center([7.5, 47.2])

            // Create the points from the data
            dataBindingPoints = dataContainer.selectAll("custom.circle")
                .data(geo.features, function(d) { return d; });

            // Create the points in D3
            dataBindingPoints.enter()
                .append("custom")
                .classed("circle", true)
                .attr("x", function(d) {
                    return projection([
                        d.geometry.coordinates[0], 
                        d.geometry.coordinates[1]])[0];
                })
                .attr("y", function(d) {
                    return projection([
                        d.geometry.coordinates[0],
                        d.geometry.coordinates[1]])[1] - 19;
                })
                .attr("r", 1)
                .attr("fill", "#fb1ba244");
            
            charge = d3.forceManyBody()
            charge.strength(0)
            charge.distanceMin(0)
            charge.distanceMax(2000)

            collide = d3.forceCollide()
            collide.strength(2)
            collide.radius(3)
            collide.iterations(1)

            forceX = d3.forceX()
            forceX.strength(0.00)

            forceY = d3.forceY()
            forceY.strength(0.00)

            simulation = d3.forceSimulation()
                //.force("center", d3.forceCenter(width / 5, height / 2))
                .force("x", forceX)
                .force("y", forceY)
                //.force("charge", charge)
                .force("collide", collide)
                .stop()

            simulation
                .nodes(geodata.features)
                .on("tick", tick);

            /*projection
              .scale(10000)
              .center([7.5, 47.2])*/

            for(var i=0; i<simulation.nodes().length; i++){
                ppos = projection([
                        simulation.nodes()[i].geometry.coordinates[0], 
                        simulation.nodes()[i].geometry.coordinates[1]])
                simulation.nodes()[i].x = ppos[0]
                simulation.nodes()[i].y = ppos[1]
            }

            d3.timer(drawCanvas);
        });

        var tick = function(e) {
            dataContainer.selectAll("custom.circle")
                .attr("x", function(d) { return d.x; })
                .attr("y", function(d) { return d.y; })
        }  

        function drawCanvas() {
            // clear canvas
            context.fillStyle = "#f5f6f7";
            context.rect(0,0,chart.attr("width"),chart.attr("height"));
            context.fill();

            // Draw points
            var circleElements =  dataContainer.selectAll("custom.circle")
            circleElements.each(function(d) {
                var node = d3.select(this);
                context.beginPath();
                context.fillStyle = node.attr("fill");
                context.arc(node.attr("x"),node.attr("y"),node.attr("r"),0,2*Math.PI);
                context.fill();
                context.closePath();
            });
        }

        $(".btn-graph-1").on("click", function(){
            dataContainer.selectAll("custom.circle")
              .transition()
              .ease(d3.easePolyOut)
              .duration(1000)
              .attr('r', function (d) { return 2; });
            simulation.restart()
        })

        $(".btn-graph-2").on("click", function(){
            dataContainer.selectAll("custom.circle")
              .transition()
              .ease(d3.easePolyOut)
              .duration(1000)
              .attr('r', function (d) { return 2 });

            charge.strength(-4)
            charge.distanceMin(0)
            charge.distanceMax(2000)

            collide.strength(2)
            collide.radius(3)
            collide.iterations(1)

            forceX = d3.forceX()
            forceX.strength(0.25)

            forceY = d3.forceY()
            forceY.strength(0.25)

            simulation.force("center", d3.forceCenter(width / 2, height / 2))
            simulation.force("x", forceX)
            simulation.force("y", forceY)
            simulation.force("charge", charge)
            simulation.force("collide", collide)

            simulation.restart()
        })

        $(".btn-graph-3").on("click", function(){
            dataContainer.selectAll("custom.circle")
              .transition()
              .ease(d3.easePolyOut)
              .duration(1000)
              .attr('r', function (d) { return 2 });

            simulation.stop()
            
            dataContainer.selectAll("custom.circle")
              .transition()
              .ease(d3.easePolyOut)
              .duration(2000)
                .attr("x", function(d) {
                return projection([
                    d.geometry.coordinates[0], 
                    d.geometry.coordinates[1]])[0];
                })
                .attr("y", function(d) {
                return projection([
                    d.geometry.coordinates[0],
                    d.geometry.coordinates[1]])[1] - 19;
                })   

        })

        $(".btn-zoom").on("click", function(){
            projection
              .scale(120000)
              .center([6.62, 46.52])

            dataContainer.selectAll("custom.circle")
              .transition()
              .ease(d3.easePolyOut)
              .duration(2000)
                .attr('r', function (d) { return Math.random()*5; })
                .attr("x", function(d) {
                return projection([
                    d.geometry.coordinates[0], 
                    d.geometry.coordinates[1]])[0];
                })
                .attr("y", function(d) {
                return projection([
                    d.geometry.coordinates[0],
                    d.geometry.coordinates[1]])[1] - 19;
                })              
        })

    </script>
  </body>
</html>